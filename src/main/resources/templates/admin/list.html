<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skincare Booking System</title>
    <link rel="stylesheet" th:href="@{/assets/themify-icons-font/themify-icons/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/list.css}">
</head>
<body>
<div id="system">
    <div th:replace="~{admin/index :: header}"></div>
    <div id="slidebar">
        <div th:replace="~{admin/index :: navbar}"></div>
        <div class="content">
            <h2>
            </h2>
            <div class="container">
                <h2>Danh sách dich vụ</h2>
                <div class="top-bar">
                    <button class="add-service-btn" onclick="openForm()">+ Thêm Dịch Vụ</button>
                </div>

                <div class="container2">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ảnh</th>
                            <th>Tên dịch vụ</th>
                            <th>Mô tả</th>
                            <th>Giá</th>
                            <th>Thời lượng</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="form-popup" id="serviceForm">
                <div class="form-container">
                    <span class="close-btn" onclick="closeForm()">&#10006;</span>
                    <h3>Thêm Dịch Vụ Mới</h3>
                    <label for="imageFile">Chọn ảnh:</label>
                    <input type="file" id="imageFile" accept="image/*">

                    <label for="ServiceName">Tên dịch vụ:</label>
                    <input type="text" id="ServiceName" placeholder="Nhập tên dịch vụ">

                    <label for="Descriptions">Mô tả:</label>
                    <input type="text" id="Descriptions" placeholder="Nhập mô tả">

                    <label for="Price">Giá:</label>
                    <input type="text" id="Price" placeholder="Nhập giá">

                    <label for="Duration">Thời lượng:</label>
                    <input type="text" id="Duration" placeholder="Nhập thời lượng">
                    <!-- Nút OK -->
                    <button class="ok-btn" type="button" onclick="addService()">OK</button>
                </div>
            </div>

            <script>
                function openForm() {
                    document.getElementById("serviceForm").style.display = "block";
                }

                function closeForm() {
                    document.getElementById("serviceForm").style.display = "none";
                }

                function addService() {
                    var img = document.getElementById("imageFile").files[0];
                    var name = document.getElementById("ServiceName").value;
                    var description = document.getElementById("Descriptions").value;
                    var price = document.getElementById("Price").value;
                    var duration = document.getElementById("Duration").value;

                    if (
                        img === "" ||
                        name === "" ||
                        description === "" ||
                        price === "" ||
                        duration === ""
                    ) {
                        alert("Vui lòng điền đầy đủ thông tin!");
                        return;
                    }

                    var serviceData = {
                        img: img,
                        name: name,
                        description: description,
                        price: parseFloat(price),
                        duration: parseInt(duration),
                    };

                    fetch("http://localhost:8080/services", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(serviceData),
                    })
                        .then((response) => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                return response.text().then((text) => {
                                    throw new Error(text || "Lỗi từ Server");
                                });
                            }
                        })
                        .then((data) => {
                            // Thêm dịch vụ vào bảng
                            var table = document.querySelector("table tbody");
                            var newRow = table.insertRow();

                            var idCell = newRow.insertCell(0);
                            var imgCell = newRow.insertCell(1)
                            var nameCell = newRow.insertCell(2);
                            var descriptionCell = newRow.insertCell(3);
                            var priceCell = newRow.insertCell(4);
                            var durationCell = newRow.insertCell(5);

                            // Sử dụng dữ liệu từ response
                            idCell.innerHTML = data.serviceId || table.rows.length;
                            imgCell.innerHTML =  `<img src="${data.img}" width="60" height="60" alt="Ảnh dịch vụ">`;
                            nameCell.innerHTML = data.name || name;
                            descriptionCell.innerHTML = data.description || description;
                            priceCell.innerHTML = data.price || price;
                            durationCell.innerHTML = data.duration || duration;

                            // Xóa dữ liệu trong form
                            document.getElementById("imageFile").value = "";
                            document.getElementById("ServiceName").value = "";
                            document.getElementById("Descriptions").value = "";
                            document.getElementById("Price").value = "";
                            document.getElementById("Duration").value = "";

                            closeForm();

                            alert("Thêm dịch vụ thành công!");
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            alert("Đã xảy ra lỗi khi thêm dịch vụ: " + error.message);
                        });
                }

                window.onload = function () {
                    fetch("http://localhost:8080/services", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("Lỗi khi tải dữ liệu: " + response.status);
                            }

                            return response.text().then((text) => {
                                if (!text) {
                                    throw new Error("Phản hồi rỗng từ server.");
                                }
                                return JSON.parse(text);
                            });
                        })
                        .then((data) => {
                            if (
                                data.result &&
                                Array.isArray(data.result) &&
                                data.result.length > 0
                            ) {
                                var table = document.querySelector("table tbody");
                                table.innerHTML = "";

                                data.result.forEach((service) => {
                                    var newRow = table.insertRow();
                                    var idCell = newRow.insertCell(0);
                                    var imgCell = newRow.insertCell(1);
                                    var nameCell = newRow.insertCell(2);
                                    var descriptionCell = newRow.insertCell(3);
                                    var priceCell = newRow.insertCell(4);
                                    var durationCell = newRow.insertCell(5);

                                    idCell.innerHTML = service.serviceId;
                                    imgCell.innerHTML = `<img src="${service.img}" width="60" height="60" alt="Ảnh dịch vụ">`;
                                    nameCell.innerHTML = service.name;
                                    descriptionCell.innerHTML = service.description;
                                    priceCell.innerHTML = service.price;
                                    durationCell.innerHTML = service.duration;
                                });
                            } else {
                                alert("Không có dịch vụ nào.");
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading services:", error);
                            alert("Đã xảy ra lỗi khi tải danh sách dịch vụ: " + error.message);
                        });
                };
            </script>
        </div>
    </div>
    <div th:replace="~{admin/index :: footer}"></div>
</div>

</body>
</html>